<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2ndCTO - Trend Dashboard</title>
    <link rel="stylesheet" href="/styles/ui-components.css">
    <link rel="stylesheet" href="/styles/tour.css">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-tertiary: #484f58;
            --accent: #00d4ff;
            --success: #238636;
            --warning: #f0883e;
            --danger: #da3633;
            --info: #58a6ff;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { 
            color: #00d4ff; 
            margin-bottom: 8px;
            font-size: 28px;
        }
        .subtitle { color: #888; margin-bottom: 30px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2a2a3e;
        }
        .stat-label { 
            font-size: 12px; 
            color: #888; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .stat-value { 
            font-size: 32px; 
            font-weight: bold; 
            color: #fff;
        }
        .stat-value.critical { color: #ff4757; }
        .stat-value.warning { color: #ffa502; }
        .stat-value.good { color: #2ed573; }
        
        .section {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #2a2a3e;
        }
        .section h2 {
            color: #00d4ff;
            font-size: 18px;
            margin-bottom: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #2a2a3e;
        }
        th {
            color: #888;
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
        }
        tr:hover { background: rgba(0, 212, 255, 0.05); }
        
        .badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-critical { background: #ff4757; color: #fff; }
        .badge-high { background: #ffa502; color: #000; }
        .badge-medium { background: #ffd700; color: #000; }
        .badge-low { background: #2ed573; color: #000; }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }
        .trend-up { color: #ff4757; }
        .trend-down { color: #2ed573; }
        .trend-stable { color: #888; }
        
        .refresh-btn {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .refresh-btn:hover { background: #33ddff; }
        
        .search-container {
            position: relative;
            margin-bottom: 24px;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 48px 14px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .search-input::placeholder {
            color: var(--text-tertiary);
        }
        
        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: 18px;
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        
        .search-suggestions.active {
            display: block;
        }
        
        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .suggestion-item:hover {
            background: var(--bg-tertiary);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-type {
            font-size: 11px;
            padding: 2px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .suggestion-text {
            flex: 1;
        }
        
        .suggestion-desc {
            font-size: 13px;
            color: var(--text-tertiary);
        }
        
        .search-results {
            margin-top: 24px;
        }
        
        .search-result-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .search-result-item:hover {
            border-color: var(--accent);
        }
        
        .search-result-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .search-result-repo {
            font-size: 13px;
            color: var(--accent);
        }
        
        .search-result-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .search-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }
        
        .loading { text-align: center; padding: 40px; color: #888; }
        .error { background: #ff4757; color: #fff; padding: 12px; border-radius: 6px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöå 2ndCTO Trend Dashboard</h1>
        <p class="subtitle">Bus Factor & Risk Analysis</p>
        
        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="üîç Search findings, files, or repositories..." autocomplete="off">
            <span class="search-icon">‚åòK</span>
            <div class="search-suggestions" id="searchSuggestions"></div>
        </div>
        
        <div class="search-filters" id="searchFilters" style="display: none;">
            <button class="filter-btn active" onclick="setSearchFilter('all')">All</button>
            <button class="filter-btn" onclick="setSearchFilter('critical')">üî¥ Critical</button>
            <button class="filter-btn" onclick="setSearchFilter('high')">üü† High</button>
            <button class="filter-btn" onclick="setSearchFilter('secret')">üîë Secrets</button>
            <button class="filter-btn" onclick="setSearchFilter('vulnerability')">üõ°Ô∏è Vulnerabilities</button>
        </div>
        
        <button class="refresh-btn" onclick="loadData()">‚Üª Refresh Data</button>
        
        <div id="searchResults" class="search-results" style="display: none;"></div>
        
        <div id="content">
            <div class="loading">Loading...</div>
        </div>
        <pre id="debug" style="margin-top: 20px; padding: 10px; background: #1a1a2e; border-radius: 6px; font-family: monospace; font-size: 11px; color: #888; max-height: 200px; overflow: auto;"></pre>
    </div>

    <script>
        const API_BASE = '';
        let currentTrends = null;
        
        function debug(msg) {
            const d = document.getElementById('debug');
            d.textContent += msg + '\n';
            console.log(msg);
        }
        
        async function loadData() {
            const content = document.getElementById('content');
            
            // Show skeleton loading instead of "Loading..."
            content.innerHTML = `
                <div class="stats-grid">
                    ${createSkeletonCard('stat')}
                    ${createSkeletonCard('stat')}
                    ${createSkeletonCard('stat')}
                    ${createSkeletonCard('stat')}
                    ${createSkeletonCard('stat')}
                    ${createSkeletonCard('stat')}
                </div>
                <div class="section">
                    <h2>üìä Repository Analysis</h2>
                    ${createSkeletonCard('table')}
                </div>
            `;
            
            try {
                const [trendsRes, reposRes] = await Promise.all([
                    fetch('/api/trends'),
                    fetch('/api/repos')
                ]);
                
                if (!trendsRes.ok) {
                    const errorData = await trendsRes.json().catch(() => ({}));
                    throw new Error(errorData.error || `Server error: ${trendsRes.status}`);
                }
                
                if (!reposRes.ok) {
                    const errorData = await reposRes.json().catch(() => ({}));
                    throw new Error(errorData.error || `Server error: ${reposRes.status}`);
                }
                
                const trends = await trendsRes.json();
                const repos = await reposRes.json();
                
                renderDashboard(trends, repos);
                
                // Show success toast on first load
                if (!window.hasLoaded) {
                    showToast({
                        type: 'success',
                        title: 'Dashboard Loaded',
                        message: `Showing ${trends.repos_analyzed} analyzed repositories`,
                        duration: 3000
                    });
                    window.hasLoaded = true;
                }
                
            } catch (error) {
                console.error('Dashboard load error:', error);
                
                content.innerHTML = createErrorState({
                    title: 'Failed to Load Dashboard',
                    message: error.message.includes('fetch') 
                        ? 'Cannot connect to server. Please check your connection.'
                        : error.message,
                    error: { code: 'LOAD_ERROR', message: error.message },
                    retryAction: 'loadData()',
                    docsLink: 'https://github.com/nKOxxx/2ndCTO#troubleshooting'
                });
                
                showToast({
                    type: 'error',
                    title: 'Load Failed',
                    message: error.message,
                    duration: 5000
                });
            }
        }
        
        function renderDashboard(trends, reposData) {
            const content = document.getElementById('content');
            
            // Store trends for viewRepo function
            currentTrends = trends;
            
            // Handle repos response structure
            const reposList = reposData.repos || reposData;
            
            // Show empty state if no data
            if (!trends.repos_analyzed || trends.repos_analyzed === 0) {
                content.innerHTML = createEmptyState({
                    icon: 'üîç',
                    title: 'No Repositories Analyzed Yet',
                    message: 'Start by analyzing a GitHub repository to see security insights, bus factor, and risk scores.',
                    actionText: '‚ûï Analyze Your First Repo',
                    actionHref: '/#analyze',
                    secondaryAction: {
                        text: 'üìñ View Documentation',
                        href: 'https://github.com/nKOxxx/2ndCTO#readme'
                    }
                });
                return;
            }
            
            const summary = trends.summary;
            const busFactorStatus = summary.avg_bus_factor <= 1.5 ? 'critical' : summary.avg_bus_factor <= 3 ? 'warning' : 'good';
            const riskStatus = summary.avg_risk_score >= 70 ? 'critical' : summary.avg_risk_score >= 40 ? 'warning' : 'good';
            
            content.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Repos Analyzed</div>
                        <div class="stat-value">${trends.repos_analyzed}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Bus Factor</div>
                        <div class="stat-value ${busFactorStatus}">${summary.avg_bus_factor}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Risk Score</div>
                        <div class="stat-value ${riskStatus}">${summary.avg_risk_score}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Critical Repos</div>
                        <div class="stat-value ${summary.critical_bus_factor_repos > 0 ? 'critical' : 'good'}">${summary.critical_bus_factor_repos}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Findings</div>
                        <div class="stat-value">${summary.total_findings}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Critical Findings</div>
                        <div class="stat-value ${summary.critical_findings > 0 ? 'critical' : 'good'}">${summary.critical_findings}</div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìä Repository Analysis</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Repository</th>
                                <th>Bus Factor</th>
                                <th>Risk Score</th>
                                <th>Status</th>
                                <th>Last Analyzed</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(trends.repos || []).map(repo => `
                                <tr onclick="viewRepo('${repo.id}')" style="cursor: pointer;">
                                    <td><strong>${repo.owner}/${repo.name}</strong></td>
                                    <td>
                                        <span class="stat-value ${repo.bus_factor <= 1.5 ? 'critical' : repo.bus_factor <= 3 ? 'warning' : 'good'}" style="font-size: 18px;">
                                            ${repo.bus_factor || 'N/A'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="stat-value ${repo.risk_score >= 70 ? 'critical' : repo.risk_score >= 40 ? 'warning' : 'good'}" style="font-size: 18px;">
                                            ${repo.risk_score || 'N/A'}
                                        </span>
                                    </td>
                                    <td>
                                        ${getStatusBadge(repo.bus_factor, repo.risk_score)}
                                    </td>
                                    <td>${formatDate(repo.measured_at)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${reposList.length === 0 ? createEmptyState({
                        icon: 'üìÅ',
                        title: 'No Repositories Added',
                        message: 'Add a GitHub repository to get started with security analysis.',
                        actionText: 'Add Repository',
                        actionHref: '/#analyze'
                    }) : ''}
                </div>
            `;
        }
        
        function getStatusBadge(busFactor, riskScore) {
            if (!busFactor) return '<span class="badge badge-medium">Not Analyzed</span>';
            if (busFactor <= 1.5 || riskScore >= 80) return '<span class="badge badge-critical">CRITICAL</span>';
            if (busFactor <= 2.5 || riskScore >= 50) return '<span class="badge badge-high">HIGH RISK</span>';
            if (busFactor <= 4) return '<span class="badge badge-medium">MEDIUM</span>';
            return '<span class="badge badge-low">LOW RISK</span>';
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            return date.toLocaleString();
        }
        
        function viewRepo(repoId) {
            const repo = currentTrends?.repos?.find(r => r.id === repoId);
            const repoName = repo ? `${repo.owner}/${repo.name}` : 'Repository';
            
            showToast({
                type: 'info',
                title: 'Opening Repository',
                message: `Loading analysis for ${repoName}...`,
                duration: 2000
            });
            
            if (repo && repo.status === 'completed') {
                window.open(`/report.html?id=${repoId}`, '_blank');
            } else {
                window.open(`/progress.html?id=${repoId}&name=${encodeURIComponent(repoName)}`, '_blank');
            }
        }
        
        // Load on page load
        loadData();
        
        // Auto-refresh every 60 seconds
        setInterval(loadData, 60000);
        
        // ========== SEARCH FUNCTIONALITY ==========
        
        const searchInput = document.getElementById('searchInput');
        const searchSuggestions = document.getElementById('searchSuggestions');
        const searchResults = document.getElementById('searchResults');
        const searchFilters = document.getElementById('searchFilters');
        let searchDebounceTimer;
        let currentSearchFilter = 'all';
        
        // Focus search on Cmd+K / Ctrl+K
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                searchInput.focus();
            }
            if (e.key === 'Escape') {
                searchSuggestions.classList.remove('active');
                searchResults.style.display = 'none';
                document.getElementById('content').style.display = 'block';
            }
        });
        
        // Debounced search suggestions
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            
            clearTimeout(searchDebounceTimer);
            
            if (query.length < 2) {
                searchSuggestions.classList.remove('active');
                return;
            }
            
            searchDebounceTimer = setTimeout(() => {
                fetchSearchSuggestions(query);
            }, 300);
        });
        
        // Search on Enter
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                if (query.length >= 2) {
                    performSearch(query);
                    searchSuggestions.classList.remove('active');
                }
            }
        });
        
        // Hide suggestions on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                searchSuggestions.classList.remove('active');
            }
        });
        
        async function fetchSearchSuggestions(query) {
            try {
                const res = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}`);
                if (!res.ok) return;
                
                const data = await res.json();
                renderSuggestions(data.suggestions);
            } catch (error) {
                console.error('Suggestions error:', error);
            }
        }
        
        function renderSuggestions(suggestions) {
            if (!suggestions || suggestions.length === 0) {
                searchSuggestions.classList.remove('active');
                return;
            }
            
            const icons = {
                rule: 'üîç',
                file: 'üìÑ',
                repo: 'üìÅ'
            };
            
            searchSuggestions.innerHTML = suggestions.map(s => `
                <div class="suggestion-item" onclick="selectSuggestion('${s.text}', '${s.type}')">
                    <span class="suggestion-type">${s.type}</span>
                    <span class="suggestion-text">${highlightMatch(s.text, searchInput.value)}</span>
                    ${s.description ? `<span class="suggestion-desc">${s.description.substring(0, 60)}...</span>` : ''}
                </div>
            `).join('');
            
            searchSuggestions.classList.add('active');
        }
        
        function highlightMatch(text, query) {
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<mark style="background: rgba(0, 212, 255, 0.3); color: inherit;">$1</mark>');
        }
        
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function selectSuggestion(text, type) {
            searchInput.value = text;
            searchSuggestions.classList.remove('active');
            performSearch(text, type);
        }
        
        async function performSearch(query, type = null) {
            showToast({
                type: 'info',
                title: 'Searching...',
                message: `Looking for "${query}"...`,
                duration: 2000
            });
            
            try {
                let url = `/api/search?q=${encodeURIComponent(query)}`;
                if (currentSearchFilter !== 'all') {
                    url += `&severity=${currentSearchFilter}`;
                }
                
                const res = await fetch(url);
                if (!res.ok) throw new Error('Search failed');
                
                const data = await res.json();
                renderSearchResults(data);
                
            } catch (error) {
                showToast({
                    type: 'error',
                    title: 'Search Failed',
                    message: error.message,
                    duration: 3000
                });
            }
        }
        
        function renderSearchResults(data) {
            // Hide main content, show results
            document.getElementById('content').style.display = 'none';
            searchResults.style.display = 'block';
            searchFilters.style.display = 'flex';
            
            if (data.findings.length === 0) {
                searchResults.innerHTML = createEmptyState({
                    icon: 'üîç',
                    title: 'No Results Found',
                    message: `No findings match "${data.query}". Try a different search term.`,
                    actionText: 'Clear Search',
                    actionHref: 'javascript:clearSearch()'
                });
                return;
            }
            
            searchResults.innerHTML = `
                <div class="section">
                    <h2>üîç Search Results</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Found ${data.total} results for "${data.query}" across ${data.repos_searched} repositories
                    </p>
                    ${data.findings.map(f => `
                        <div class="search-result-item" onclick="viewFinding('${f.repo.id}', '${f.id}')">
                            <div class="search-result-header">
                                <span class="badge badge-${f.severity}">${f.severity.toUpperCase()}</span>
                                <span class="search-result-repo">${f.repo.owner}/${f.repo.name}</span>
                                <span style="color: var(--text-tertiary); font-size: 13px;">${f.category}</span>
                            </div>
                            <div style="font-weight: 500;">${f.description}</div>
                            <div class="search-result-desc">
                                üìÅ ${f.file_path}${f.line_number ? `:${f.line_number}` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function setSearchFilter(filter) {
            currentSearchFilter = filter;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Re-search with filter
            if (searchInput.value.trim().length >= 2) {
                performSearch(searchInput.value.trim());
            }
        }
        
        function clearSearch() {
            searchInput.value = '';
            searchResults.style.display = 'none';
            searchFilters.style.display = 'none';
            document.getElementById('content').style.display = 'block';
            searchSuggestions.classList.remove('active');
        }
        
        function viewFinding(repoId, findingId) {
            showToast({
                type: 'info',
                title: 'Opening Finding',
                message: 'Loading report...',
                duration: 1500
            });
            window.open(`/report.html?id=${repoId}#finding-${findingId}`, '_blank');
        }
    </script>
    
    <!-- Tour Components -->
    <script src="/components/tour.js"></script>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
</body>
</html>
